#+BEGIN_SRC jupyter-julia
using TMatrices
pyplot()
#+END_SRC

#+RESULTS:
:RESULTS:
: ‚îå Info: Precompiling TMatrices [d32406b6-cfbb-43c5-b6a9-648d7495ab4a]
: ‚îî @ Base loading.jl:1260
: Plots.PyPlotBackend()
:END:

#+BEGIN_SRC jupyter-julia
  # target_k = 1.0
  target_k = 0.1
#+END_SRC

#+RESULTS:
:RESULTS:
: 0.1
:END:

#+BEGIN_SRC jupyter-julia
    mass = 1.
    hbr = 1.
    
    en = target_k^2/2mass
    if false
        en += 0.1im
    end

    rmin,rmax = 1e-8,10.
    
    l = 0

#+END_SRC

#+RESULTS:
:RESULTS:
: 0
:END:

#+BEGIN_SRC jupyter-julia
  Gaussian = TMatrices.Gaussian
  SquareWell = TMatrices.SquareWell
    # potfunc = R -> Gaussian(R, height=1e-1)
    # potfunc = R -> Gaussian(R, height=10.)
    # potfunc = R -> Gaussian(R, height=1e-3)
    # potfunc = R -> Gaussian(R, height=1.)

    # potfunc = R -> SquareWell(R, height=1e-2)
    # potfunc = R -> SquareWell(R, height=1e-3)
    # potfunc = R -> SquareWell(R, height=1)
    # potfunc = R -> SquareWell(R, height=1e2)
    # potfunc = R -> SquareWell(R, height=1e3)

    # potfunc = R -> SquareWell(R, height=-1)
    # potfunc = R -> SquareWell(R, height=-1e-2)

    potfunc = TMatrices.TestCase
#+END_SRC

#+RESULTS:
:RESULTS:
: TestCase (generic function with 1 method)
:END:

#+BEGIN_SRC jupyter-julia
    k_list,u = TMatrices.LS.Quadrature(en)

    M,Vmat = TMatrices.LS.SetupMatrix(k_list, target_k, potfunc, en, l, u ; rmin=rmin, rmax=rmax )
    T = (I - M)\Vmat
#+END_SRC

#+RESULTS:
:RESULTS:
# [goto error]
: MethodError: no method matching SetupMatrix(::Array{Float64,1}, ::Float64, ::typeof(TMatrices.TestCase), ::Float64, ::Int64, ::Array{Complex{Float64},1}; rmin=1.0e-8, rmax=10.0)
: Closest candidates are:
:   SetupMatrix(::Any, ::Any, ::Any, ::Any; rmin, rmax, pot_k) at /home/pengwyn/work5/julia_packages/TMatrices/src/LS.jl:78
: 
: Stacktrace:
:  [1] top-level scope at In[5]:2
:END:

#+BEGIN_SRC jupyter-julia
  ind = findfirst(==(target_k), k_list)
  T_ls = T[ind]
#+END_SRC

#+RESULTS:
:RESULTS:
# [goto error]
: UndefVarError: T not defined
: 
: Stacktrace:
:  [1] top-level scope at In[6]:2
:END:

#+BEGIN_SRC jupyter-julia
  # using Scattering
  f_ls = -(2pi)^2*mass / (hbr^2) * T_ls
#+END_SRC

#+RESULTS:
:RESULTS:
# [goto error]
: UndefVarError: T_ls not defined
: 
: Stacktrace:
:  [1] top-level scope at In[7]:1
:END:

#+BEGIN_SRC jupyter-julia
  en = 0.5
  l = 0
TMatrices.LS.OnShellScattering(en, l, potfunc)
#+END_SRC

#+RESULTS:
:RESULTS:
: -0.15570064893311403 - 0.12617610393113016im
:END:

#+BEGIN_SRC jupyter-julia
  en = -0.5 - 0.05im
  l = 0
  k_list,T = TMatrices.LS.OffShellScattering(en, l, potfunc)
#+END_SRC

#+RESULTS:
:RESULTS:
: '((0.001303049825344807  0.006738434806738754  0.016009571831409428  0.028294971529768342  0.04250331906455318  0.05737222460945168  0.07158057214423652  0.08386597184259544  0.09313710886726612  0.09857249384866006  0.2376690142144973  0.8293300931771739  1.908218445414322  3.501309241528903  5.652371683737808  8.430028290438495  11.943661381574056  16.379133375052113  22.09646135565476  30.0205725559479)  Complex(Float64)(-3.9751524483037186 - 0.10121468382571387im -3.973106848733413 - 0.10120249812151996im ‚Ä¶ -0.001664520278056462 - 7.44322208328887e-5im 0.0030978789882970307 + 0.00013447936442218856im; -3.973106848733414 - 0.10120249812151999im -3.972176019928264 - 0.101190314089718im ‚Ä¶ -0.0016643976969581338 - 7.442402153341771e-5im 0.00309767445434283 + 0.00013446420514479096im; ‚Ä¶ ; -0.0016645202780564618 - 7.443222083288867e-5im -0.001664397696958133 - 7.442402153341767e-5im ‚Ä¶ 0.0023657952336992214 - 1.2516434096063712e-7im -0.0004814431148883923 + 2.0411958414165515e-7im; 0.003097878988297031 + 0.0001344793644221886im 0.0030976744543428306 + 0.0001344642051447909im ‚Ä¶ -0.00048144311488839255 + 2.041195841416551e-7im 0.0013225537897614825 - 3.999449900081296e-7im))
:END:

#+BEGIN_SRC jupyter-julia
  Taa = diag(T)
  ŒîE = @. en - k_list^2/2
  plot(k_list, [real.(Taa) imag.(Taa) real.(ŒîE) imag.(ŒîE)], label=["real" "imag" "ŒîE_r" "ŒîE_i"])
  #hline!([imag(en)], label="E_i")
  ylims!(-5,1)
#+END_SRC

#+RESULTS:
:RESULTS:
[[file:./.ob-jupyter/ad10d40da8e16bb81111df7a798c3080a16be465.png]]
:END:


** ODE version

#+BEGIN_SRC jupyter-julia
potode = R -> potfunc(ustrip(a0,R)) * E‚Çï
E_ode = en*Eh
k_ode = TMatrices.ODE.kFromE(E_ode)
Œ∫ = k_ode
rspan = (0.001a0, 50.0a0)
#+END_SRC

#+RESULTS:
:RESULTS:
| 0.001 | a‚ÇÄ | 50.0 | a‚ÇÄ |
:END:

#+BEGIN_SRC jupyter-julia
r,u,u‚Ä≤ = TMatrices.ODE.SolveOutwards(rspan, E_ode, k_ode, potode, l)
#+END_SRC

#+RESULTS:
:RESULTS:
: '(Quantity(Float64 ùêã Unitful.FreeUnits((a‚ÇÄ ) ùêã nothing))(0.001 a‚ÇÄ  0.002787416502493408 a‚ÇÄ  0.005640085023848537 a‚ÇÄ  0.008922220932755662 a‚ÇÄ  0.013000516286632471 a‚ÇÄ  0.01760147742398289 a‚ÇÄ  0.022797752508986496 a‚ÇÄ  0.028442374522356092 a‚ÇÄ  0.03450039242874372 a‚ÇÄ  0.04087465323723429 a‚ÇÄ  ‚Ä¶  49.88873689040033 a‚ÇÄ  49.90198013567821 a‚ÇÄ  49.91522337429039 a‚ÇÄ  49.928466615884595 a‚ÇÄ  49.94170985169017 a‚ÇÄ  49.95495309924843 a‚ÇÄ  49.968196335755664 a‚ÇÄ  49.98143958313852 a‚ÇÄ  49.99468282297861 a‚ÇÄ  50.0 a‚ÇÄ)  Quantity(Complex(Float64) ùêã Unitful.FreeUnits((a‚ÇÄ ) ùêã nothing))(-0.0035449082926290155 - 5.908180108343819e-11im a‚ÇÄ -0.0035448498512029567 - 6.253508309387151e-10im a‚ÇÄ ‚Ä¶ -2.6364162239791366e21 + 1.5660808159169334e21im a‚ÇÄ -2.650907376903446e21 + 1.5737367198772403e21im a‚ÇÄ; -0.0035449082926290155 - 5.908180108343819e-11im a‚ÇÄ -0.001757414313510051 - 5.301745316011082e-10im a‚ÇÄ ‚Ä¶ -5.483056428674119e21 + 3.760532385349836e21im a‚ÇÄ -5.513328643221666e21 + 3.7791422954221947e21im a‚ÇÄ)  Complex(Float64)(0.0 + 0.0im 0.00010125644859222148 + 6.336124299143873e-7im ‚Ä¶ -2.717908085946197e21 - 1.436375579486502e21im -2.7327996152860697e21 - 1.4433173676885059e21im; 1.0 + 0.0im 1.0001332051972354 + 4.7386784105343486e-7im ‚Ä¶ -5.67768155099874e21 - 3.4914068169787803e21im -5.708920825623616e21 - 3.508528190179921e21im))
:END:

  #+BEGIN_SRC jupyter-julia
    X = TMatrices.ODE.MatchSolution(u[end], u‚Ä≤[end], r[end], Œ∫, l)
    soln2 = TMatrices.ODE.EliminateIngoing(u, u‚Ä≤, r, Œ∫, l)
    soln2 = TMatrices.ODE.AddBesselPart(r, soln2..., Œ∫, l)
  #+END_SRC

  #+RESULTS:
  :RESULTS:
  | Quantity | (Complex (Float64) ùêã Unitful.FreeUnits ((a‚ÇÄ) ùêã nothing)) | (0.0 + 0.0im a‚ÇÄ 0.005060816158067956 + 5.862900672075071e-10im a‚ÇÄ 0.013138545197463315 + 5.536990639804973e-9im a‚ÇÄ 0.022435098236395282 + 2.4870212750364033e-8im a‚ÇÄ 0.033993709826116845 + 8.370431892092978e-8im a‚ÇÄ 0.04704742124755085 + 2.1897745166883377e-7im a‚ÇÄ 0.06181437915149836 + 4.930699819025234e-7im a‚ÇÄ 0.07789355327277817 + 9.8156900578081e-7im a‚ÇÄ 0.09520582452588663 + 1.7840883228276621e-6im a‚ÇÄ 0.11349752939954594 + 3.008409927117985e-6im a‚ÇÄ ‚Ä¶ -7.218927663734663e+21 + 5.626151738523861e21im a‚ÇÄ -7.319055112085922e+21 + 5.696410758605193e21im a‚ÇÄ -7.420566077992895e+21 + 5.767540445899356e21im a‚ÇÄ -7.523479685965783e+21 + 5.839551546626373e21im a‚ÇÄ -7.627815179981857e+21 + 5.912454837556346e21im a‚ÇÄ -7.73359227684058e+21 + 5.986261372155965e21im a‚ÇÄ -7.840830640802027e+21 + 6.060982112820803e21im a‚ÇÄ -7.949550568033173e+21 + 6.136628407390519e21im a‚ÇÄ -8.059772302580469e+21 + 6.213211511479106e21im a‚ÇÄ -8.10445366503549e+21 + 6.244225892114776e21im a‚ÇÄ) | Complex | (Float64) | (2.831327928390701 + 1.772454146482824e-7im 2.8314183857749846 + 2.1247468343605896e-6im 2.831937546251062 + 8.051127454968008e-6im 2.8331051010182184 + 1.9155829097295466e-5im 2.8354063724543135 + 3.9340782308959664e-5im 2.839134917371482 + 7.060059887811304e-5im 2.844791435922939 + 0.00011670929836413393im 2.852677034234247 + 0.00017975280764245073im 2.863162848871193 + 0.00026237508459851864im 2.87646536158761 + 0.00036596207249134686im ‚Ä¶ -7.508880753322862e+21 + 5.320962382250972e21im -7.612641550816405e+21 + 5.387683986366169e21im -7.717831069067059e+21 + 5.455236336843692e21im -7.82446899305862e+21 + 5.52362974338361e21im -7.93257512891645e+21 + 5.592874546781235e21im -8.042169769994881e+21 + 5.662981352751041e21im -8.153273152495517e+21 + 5.733960682641128e21im -8.265906164562498e+21 + 5.805823426103686e21im -8.38008963754895e+21 + 5.878580387384751e21im -8.426375467144827e+21 + 5.908046479390732e21im) |
  :END:

  #+BEGIN_SRC jupyter-julia
    using Plots
    using UnitfulRecipes
    plot(r,abs.(soln2[1]))
  #+END_SRC

  #+RESULTS:
  :RESULTS:
  [[file:./.ob-jupyter/af1dfe9277b3ffd3cea026dff8783fe9c2eeb487.png]]
  :END:

  #+BEGIN_SRC jupyter-julia
    costh = 0.
    u2 = soln2[1]
    T_ode = TMatrices.ODE.Tmat_l(r, u2, potode, k_ode, costh, l)
    T_ode * 4œÄ
  #+END_SRC

  #+RESULTS:
  :RESULTS:
  : -933.4906031967373 - 839.0855623302109im a‚ÇÄ^3 E‚Çï
  :END:

  #+BEGIN_SRC jupyter-julia
f_ode = TMatrices.ODE.fFromT(T_ode)
  #+END_SRC

  #+RESULTS:
  :RESULTS:
  : 2932.647221197975 + 2636.065038349851im a‚ÇÄ
  :END:
  
  #+BEGIN_SRC jupyter-julia
TMatrices.ODE.TCSandOptTheorem(f,Œ∫)
  #+END_SRC

  #+RESULTS:
  :RESULTS:
  # [goto error]
  : UndefVarError: f not defined
  : 
  : Stacktrace:
  :  [1] top-level scope at In[17]:1
  :END:



* asdf


#+BEGIN_SRC jupyter-julia
  en1 = 1.5 + 0im
  en2 = 2.0 + 0im
  l = 0
  k_list1,T1 = TMatrices.LS.OffShellScattering(en1, l, potfunc, N=70, N_mid=10)
  k_list2,T2 = TMatrices.LS.OffShellScattering(en2, l, potfunc, N=70, N_mid=10)

  plot(k_list1, [real(diag(T1)) imag(diag(T1))], marker=:circle)
  plot!(k_list2, [real(diag(T2)) imag(diag(T2))], line=:dash, label="")
  ylims!(-0.5,0.1)
  xlims!(0,5)
#+END_SRC

#+RESULTS:
:RESULTS:
[[file:./.ob-jupyter/fd8f199a82621461976d116544524971c9441a27.png]]
:END:

#+BEGIN_SRC jupyter-julia
  k_target = 0.0001
  c = 0.1
  TMatrices.LS.SearchLax(k_target, potfunc, c, N=50)#, zero_limit=true)
#+END_SRC

#+RESULTS:
:RESULTS:
: -0.42819625397706873 - 1.7319448104438629e-6im
:END:

#+BEGIN_SRC jupyter-julia
  k_target = 0.2
  c = 0.1
  TMatrices.LS.SearchLax(k_target, potfunc, c, N=50)
#+END_SRC

#+RESULTS:
:RESULTS:
: -0.37072103321134875 - 8.592368062640484e-6im
:END:

#+BEGIN_SRC jupyter-julia
  k_list = linspace(0, 2.0, 51)
  c = 0.1
  E_list = TMatrices.LS.LaxScan(k_list, potfunc, c, N=10, Œ±=0.1, tol=1e-5, max_iters=1001)
#+END_SRC

#+RESULTS:
:RESULTS:
: [32mProgress: 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| Time: 0:01:20[39m
#+BEGIN_EXAMPLE
51-element Array{Any,1}:
  -0.4340546068209168 - 1.0619384264165297e-5im
  -0.4312949227031151 - 6.44392868863991e-7im
  -0.4239745200727658 - 2.5439858703185725e-8im
  -0.4128829228515912 - 9.538660966386663e-10im
 -0.39877948186175477 - 3.531172656852618e-11im
 -0.38217784223324897 - 2.4568855137389064e-12im
  -0.3633740827941613 - 3.1488061739163006e-13im
  -0.3425758792506343 + 4.7722719140625604e-8im
  -0.3202698375067368 + 5.0308415614304785e-9im
  -0.2967583092710029 + 8.416839945133156e-10im
  -0.2724780987793784 + 2.4817384127647615e-10im
 -0.24790485010667643 + 1.3926298300303804e-10im
 -0.22356670494331038 + 1.6282502369011094e-10im
                      ‚ãÆ
   1.2114176945783661 + 2.3041614021235855e-29im
   1.2752736724243898 + 6.550153876551837e-33im
   1.3406781246852324 + 1.5845235913320322e-36im
   1.4076365144440983 + 3.367877652929805e-40im
   1.4761530595391306 + 6.458538928159987e-44im
   1.5462328768218516 + 1.1422356212178815e-47im
   1.6178798148372608 + 1.7106092815150183e-51im
   1.6910954612649218 + 2.4416424292540707e-55im
   1.7658834315548801 + 3.364471552975469e-59im
   1.8422458480198276 + 4.5237882695316007e-63im
   1.9201851673175832 + 5.98831995262509e-67im
   1.9997042049021994 + 7.0775062679139715e-71im
#+END_EXAMPLE
:END:

#+BEGIN_SRC jupyter-julia :file testcase.png
  plot(k_list, [real.(E_list) imag.(E_list)], marker=:circle, xlabel="k (1/a‚ÇÄ)", label=["Œµ" "Œì"])
#+END_SRC
#+RESULTS:
:RESULTS:
[[file:testcase.png]]
:END:
